---
deployment:
  tasks:
    - set -e
    - cd /home/familyre/repositories/family-reminder

    # Composer install
    - /opt/cpanel/composer/bin/composer install --no-dev --optimize-autoloader

    # Set deploy path
    - export DEPLOYPATH=/home/familyre/public_html

    # Copy public files to deploy path
    - /bin/cp -R public/* $DEPLOYPATH

    # Decrypt credentials.json
    - openssl enc -d -aes-256-cbc -pbkdf2 -in writable/credentials.json.enc -out writable/credentials.json -pass pass:Avclinic@123

    # Patch index.php for correct path to app
    - sed -i "s|require FCPATH\s*\.\s*'\.\./app/Config/Paths.php';|require __DIR__ . '/../repositories/family-reminder/app/Config/Paths.php';|" $DEPLOYPATH/index.php

    # Optional: Log debug info
    - echo "Deployed at $(date)"